<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Đang tạo nội dung…</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://unpkg.com/@lottiefiles/lottie-player@latest/dist/lottie-player.js"></script>
  <style>
    :root {
      --primary: #FF6B6B; --primary-dark: #FF4757; --secondary: #7871FF; --success: #00D2D3;
      --warning: #FFA502; --background: #2C2F4A; --card-bg: #353B64; --text-primary: #FFFFFF;
      --text-secondary: #B8C6DB; --border: #4B4F7C; --accent: #FF6B6B;
    }
    body { font-family: 'Inter', sans-serif; background: linear-gradient(135deg, var(--background) 0%, #1e1b4b 100%); color: var(--text-primary); min-height:100vh; padding:20px; }
    .container{max-width:1100px;margin:0 auto;}
    .header{ text-align:center; margin-bottom:1.5rem; padding:1rem 0; position:relative; }
    .logo{ display:flex; align-items:center; justify-content:center; gap:12px; }
    .logo-icon{ font-size:2.2rem; color:var(--warning); }
    .logo-text{ font-size:1.8rem; font-weight:700; background: linear-gradient(135deg,#FF6B6B,#FFA502); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
    .subtitle{ color:var(--text-secondary); }
    .card{ background:var(--card-bg); border:1px solid var(--border); border-radius:16px; box-shadow: 0 10px 30px rgba(0,0,0,.3); margin-bottom:1rem; overflow:hidden; }
    .card-header{ background: rgba(30,41,59,.8); padding:1rem 1.25rem; border-bottom:1px solid var(--border); }
    .table-title{ font-size:1.1rem; margin:0; display:flex; align-items:center; gap:8px; }
    .progress-wrap{ background: rgba(15,23,42,.6); border:1px solid var(--border); border-radius: 12px; padding: 16px; margin-bottom: 20px;}
    .progress{ height: 12px; background: rgba(255,255,255,.1); }
    .progress-bar{ background: linear-gradient(135deg, var(--primary), var(--warning)); }
    .small{ color:var(--text-secondary); }
    .article-row{ display:grid; grid-template-columns: 80px 1fr 2fr 1fr 1fr; gap:1rem; padding:1rem; border-bottom:1px solid var(--border); }
    .article-badge{ background: var(--primary); color:#fff; width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700; }
    .content-item{ background: rgba(15,23,42,0.5); border:1px solid var(--border); border-radius:8px; padding:.75rem; }
    .content-label{ font-size:.75rem; color:var(--text-secondary); margin-bottom:.25rem; display:flex; gap:6px; align-items:center; }
    .content-text{ font-size:.875rem; color: var(--text-primary); }
    .link-item{ display:block; padding:.5rem .75rem; background: rgba(15,23,42,.5); border-radius:6px; color:var(--text-primary); text-decoration:none; border:1px solid transparent; word-break:break-all; }
    .btn-back{ background: var(--card-bg); border:1px solid var(--border); color:var(--text-primary); padding:.6rem 1rem; border-radius:10px; text-decoration:none; display:inline-flex; gap:8px; }
    .btn-back:hover{ background: var(--primary); color:#fff; }
    @media (max-width: 1200px){ .article-row{ grid-template-columns:60px 1fr 1fr; } }
    @media (max-width: 768px){ .article-row{ grid-template-columns:1fr; } }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div style="position:relative; min-height:64px;">
        <div class="logo">
          <svg class="logo-icon" width="52" height="52" viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">
            <defs><linearGradient id="g2" x1="0" x2="1"><stop offset="0" stop-color="#7871FF" /><stop offset="1" stop-color="#00D2D3" /></linearGradient></defs>
            <circle cx="32" cy="32" r="28" fill="url(#g2)" opacity="0.12" />
            <path d="M18 42c6-6 18-6 24 0" stroke="#7871FF" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round" />
            <path d="M32 10c4 6 12 10 18 12-6 2-10 6-18 6s-12-4-18-6c6-2 14-6 18-12z" fill="#7871FF" />
            <circle cx="32" cy="26" r="3" fill="#fff" opacity="0.9" />
          </svg>
          <div class="logo-text">Đang tạo nội dung…</div>
        </div>
        <p class="subtitle">Job ID: <code>{{ job_id }}</code></p>
      </div>
    </div>

    <div class="progress-wrap">
      <div class="d-flex justify-content-between">
        <div class="small">Tiến độ</div>
        <div class="small"><span id="progress-text">0%</span></div>
      </div>
      <div class="progress"><div id="progress-bar" class="progress-bar" role="progressbar" style="width: 0%;"></div></div>
      <div class="small mt-2"><span id="count">0</span>/<span id="total">?</span> bài đã xong</div>
      <div id="err" class="text-danger mt-2" style="display:none;"></div>
    </div>

    <div class="card">
      <div class="card-header">
        <h3 class="table-title"><i class="fas fa-newspaper"></i> Kết quả (cập nhật trực tiếp)</h3>
      </div>
      <div id="articles"></div>
    </div>

    <div class="mt-3">
      <a id="full-link" class="btn-back" href="#">Xem bản đầy đủ</a>
      <a class="btn-back" href="/">Tạo job mới</a>
    </div>
  </div>

  <script>
    const jobId = "{{ job_id }}";
    document.getElementById('full-link').href = `/full/${jobId}`;

    const renderedNos = new Set();
    function renderArticle(a) {
      if (!a) return "";
      const embedded = (a.embedded || []).map(t => `<div class="embedded-link">${t.html}</div>`).join("");
      return `
      <div class="article-row" id="row-${a.no}">
        <div class="article-number"><div class="article-badge">${a.no}</div></div>
        <div class="article-title-section">
          <div class="content-item"><div class="content-label"><i class="fas fa-heading"></i> TIÊU ĐỀ</div><div class="content-text">${a.title}</div></div>
          <div class="content-item"><div class="content-label"><i class="fas fa-robot"></i> NỘI DUNG AI</div><div class="content-text" id="ai_content_${a.no}">${a.ai_html}</div></div>
        </div>
        <div class="article-content-section">
          <div class="content-item"><div class="content-label"><i class="fas fa-sitemap"></i> LIÊN KẾT NHÚNG (${(a.embedded||[]).length})</div>
            <div class="embedded-links" id="embedded_${a.no}">${embedded}</div>
          </div>
        </div>
        <div class="links-section">
          <div class="content-item"><div class="content-label"><i class="fas fa-link"></i> LIÊN KẾT CHÍNH</div>
            <a href="${a.main_link}" target="_blank" class="link-item"><i class="fas fa-external-link-alt"></i> ${a.main_link}</a>
          </div>
          <div class="content-item"><div class="content-label"><i class="fab fa-microsoft"></i> BING SEARCH</div>
            <a href="${a.bing_link}" target="_blank" class="link-item"><i class="fas fa-search"></i> ${a.bing_link}</a>
          </div>
        </div>
        <div class="actions-section">
          <button class="btn-back" onclick="copyText('${(a.title||'').replace(/'/g, '\\\'')}', 'Tiêu đề bài ${a.no}')"><i class="fas fa-copy"></i> Copy Tiêu đề</button>
          <button class="btn-back" onclick="copyBlock('ai_content_${a.no}', 'Nội dung AI bài ${a.no}')"><i class="fas fa-copy"></i> Copy Nội dung AI</button>
          <button class="btn-back" onclick="copyBlock('embedded_${a.no}', 'Liên kết nhúng bài ${a.no}')"><i class="fas fa-copy"></i> Copy Links nhúng</button>
        </div>
      </div>`;
    }
    function patchArticles(list) {
      const container = document.getElementById('articles');
      list.forEach(a => {
        if (!renderedNos.has(a.no)) {
          renderedNos.add(a.no);
          container.insertAdjacentHTML('beforeend', renderArticle(a));
        }
      });
    }
    function updateProgress(p, count, total, error) {
      const bar = document.getElementById('progress-bar');
      const txt = document.getElementById('progress-text');
      const ct = document.getElementById('count');
      const tt = document.getElementById('total');
      const err = document.getElementById('err');
      const percent = Math.round((p || 0) * 100);
      bar.style.width = percent + '%';
      txt.textContent = percent + '%';
      ct.textContent = count;
      tt.textContent = total;
      if (error) { err.textContent = error; err.style.display = 'block'; }
    }
    function copyText(text, type) { navigator.clipboard.writeText(text); }
    function copyBlock(id, type) {
      const el = document.getElementById(id);
      if (!el) return;
      const plain = el.innerText;
      navigator.clipboard.writeText(plain);
    }
    let done = false;
    function tick() {
      if (done) return;
      fetch(`/api/result/${jobId}`)
        .then(r => r.json())
        .then(data => {
          if (data.error) { updateProgress(0, 0, 0, data.error); done = True; return; }
          const total = data.total || 0;
          const arts = data.articles || [];
          const p = data.progress || (total ? arts.length/total : 0);
          patchArticles(arts);
          updateProgress(p, arts.length, total, data.error || null);
          if (data.done) { done = true; }
        }).catch(()=>{});
    }
    setInterval(tick, 1000);
    tick();
  </script>
</body>
</html>
